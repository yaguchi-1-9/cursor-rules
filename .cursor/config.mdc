---
description: 
globs: 
alwaysApply: true
---
# Cursor Configuration
Description: Cursorの設定ファイル

# ワークフロー設定
## 1. 実装案生成 (plan)
### 説明
実装案を３つ生成し、メリデメ＋おすすめを提示する

### 設定
```yaml
workflow:
  name: plan
  description: 実装案を３つ生成し、メリデメ＋おすすめを提示する
  rules: 
    - .cursor/rules/project_rules.mdc
    - .cursor/rules/plan.mdc
    - .cursor/rules/architecture.mdc
    - .cursor/rules/php.mdc
    - .cursor/rules/docker.mdc
  inputs:
    - name: inputFile
      type: file
      description: 要件を記述したYAML/JSONファイルを選択してください
    - name: currentVersion
      type: string
      description: package.jsonから取得した現在のバージョン
      default: ${package.json.version}
```

### 実行手順
1. 要件の分析
   - 機能要件の整理
     - 必須機能
     - オプション機能
     - 将来の拡張性
   - 非機能要件の整理
     - パフォーマンス要件
     - セキュリティ要件
     - スケーラビリティ要件
   - 制約条件の確認
     - 技術的制約
     - ビジネス制約
     - リソース制約
   - 優先度の考慮
     - ビジネス価値
     - 技術的複雑さ
     - リスク要因

2. 全体設計
   - アーキテクチャ設計
     - システム構成図
     - コンポーネント図
     - デプロイメント図
   - データベース設計
     - ER図
     - テーブル定義
     - インデックス戦略
   - API設計
     - エンドポイント設計
     - リクエスト/レスポンス形式
     - 認証・認可設計
   - セキュリティ設計
     - 認証方式
     - データ保護
     - アクセス制御
   - パフォーマンス設計
     - キャッシュ戦略
     - スケーリング戦略
     - 負荷分散

3. 実装案の提示（表形式）
   - 案1: シンプルな実装
     - 最小限の機能実装
     - 基本的なアーキテクチャ
     - 短期的な開発期間
   - 案2: 拡張性を重視した実装
     - モジュール化された設計
     - 柔軟なアーキテクチャ
     - 中期的な開発期間
   - 案3: 将来性を考慮した実装
     - 高度な機能実装
     - スケーラブルなアーキテクチャ
     - 長期的な開発期間

4. 各案の評価
   - 工数（小・中・大）
     - 開発期間
     - 必要なリソース
     - コスト見積もり
   - 拡張性（高・中・低）
     - 機能追加の容易さ
     - スケーラビリティ
     - 保守性
   - 保守性（高・中・低）
     - コードの可読性
     - テスト容易性
     - デバッグ容易性
   - 具体的なメリット・デメリット
     - 技術的観点
     - ビジネス観点
     - 運用観点
   - リスク評価
     - 技術的リスク
     - ビジネスリスク
     - 運用リスク
   - 技術的負債の見積もり
     - 短期的な負債
     - 長期的な負債
     - 対策コスト

5. おすすめ案の提示
   - 選択理由
     - 技術的妥当性
     - ビジネス適合性
     - リスク評価
   - 実装概要
     - アーキテクチャ概要
     - 主要コンポーネント
     - 開発フェーズ
   - 想定される課題
     - 技術的課題
     - ビジネス課題
     - 運用課題
   - リスク対策
     - 予防策
     - 対応策
     - モニタリング
   - 代替案の検討
     - フォールバック案
     - 段階的実装
     - 移行戦略

## 2. タスク分解 (breakdown)
### 説明
選択案を受けてタスク分解する

### 設定
```yaml
workflow:
  name: breakdown
  description: 選択案を受けてタスク分解する
  rules: 
    - .cursor/rules/project_rules.mdc
    - .cursor/rules/breakdown.mdc
    - .cursor/rules/architecture.mdc
    - .cursor/rules/php.mdc
    - .cursor/rules/docker.mdc
  dependencies:
    - previous: lastResponse
    - name: currentVersion
      type: string
      description: package.jsonから取得した現在のバージョン
      default: ${package.json.version}
```

### 実行手順
1. プロジェクト構造
   - ディレクトリ構成
   - ファイル命名規則
   - コーディング規約
   - バージョン管理方針
   - デプロイメント戦略

2. データベース設計
   - テーブル定義
   - インデックス設計
   - マイグレーション計画
   - バックアップ戦略
   - パフォーマンス考慮事項

3. アプリケーション設計
   - クラス図
   - シーケンス図
   - ユースケース図
   - アーキテクチャパターン
   - セキュリティ設計

4. 実装タスク
   - 優先順位付け
   - 依存関係の整理
   - 工数見積もり
   - リソース配分
   - マイルストーン設定

5. テスト計画
   - テスト項目
   - テストデータ
   - テスト環境
   - 自動化戦略
   - 品質基準

## 3. 設計フェーズ (design)
### 説明
タスク分解を受けて、詳細な設計を行う

### 設定
```yaml
workflow:
  name: design
  description: タスク分解を受けて、詳細な設計を行う
  rules: 
    - .cursor/rules/project_rules.mdc
    - .cursor/rules/design.mdc
    - .cursor/rules/architecture.mdc
    - .cursor/rules/php.mdc
    - .cursor/rules/docker.mdc
  dependencies:
    - previous: lastResponse
  inputs:
    - name: currentVersion
      type: string
      description: package.jsonから取得した現在のバージョン
      default: ${package.json.version}
```

### 実行手順
1. データベース設計
   - テーブル定義
     - テーブル名と説明
     - カラム定義（名前、型、制約）
     - インデックス設計
     - 外部キー制約
   - マイグレーション計画
     - マイグレーションファイルの作成
     - ロールバック手順
   - パフォーマンス考慮事項
     - インデックス戦略
     - パーティショニング
     - アーカイブ戦略

2. クラス設計
   - ドメインモデル
     - エンティティの定義
     - 値オブジェクトの定義
     - ドメインサービスの定義
   - ユースケース
     - インターフェースの定義
     - 実装クラスの設計
     - 依存関係の整理
   - リポジトリ
     - インターフェースの定義
     - 実装クラスの設計
     - クエリの最適化

3. API設計
   - エンドポイント定義
     - パス設計
     - HTTPメソッド
     - リクエスト/レスポンス形式
   - 認証・認可
     - 認証方式
     - 権限設計
     - トークン管理
   - エラーハンドリング
     - エラーコード
     - エラーメッセージ
     - リトライ戦略

4. フロントエンド設計
   - コンポーネント設計
     - コンポーネントの分割
     - 状態管理
     - イベントハンドリング
   - スタイル設計
     - デザインシステム
     - レスポンシブ対応
     - アクセシビリティ
   - パフォーマンス最適化
     - レンダリング最適化
     - アセット最適化
     - キャッシュ戦略

5. テスト設計
   - テストケース設計
     - ユニットテスト
     - 統合テスト
     - E2Eテスト
   - テストデータ設計
     - テストデータの準備
     - モックデータの設計
     - フィクスチャの設計
   - テスト環境設計
     - 環境構築
     - 設定管理
     - データベース設定

## 4. コード変更生成 (apply)
### 説明
指定ステップを実行し、ファイル変更を生成する

### 設定
```yaml
workflow:
  name: apply
  description: 指定ステップを実行し、ファイル変更を生成する
  rules: 
    - .cursor/rules/project_rules.mdc
    - .cursor/rules/apply.mdc
    - .cursor/rules/architecture.mdc
    - .cursor/rules/php.mdc
    - .cursor/rules/docker.mdc
  dependencies:
    - previous: lastResponse
```

### 実行手順
1. 変更内容の確認
   - 変更対象ファイルの特定
   - 既存コードの分析
   - 変更範囲の決定
   - 影響範囲の評価
   - リグレッションテストの確認
   - バージョン番号の確認と更新

2. コード生成
   - 新規ファイルの作成
   - 既存ファイルの修正
   - テストコードの追加
   - ドキュメントの更新
   - コメントの追加
   - package.jsonのバージョン更新

3. 品質チェック
   - コーディング規約の遵守
   - エラーハンドリングの実装
   - セキュリティ対策の実装
   - パフォーマンス最適化
   - ユニットテストの実行

4. レビューと改善
   - コードレビューの実施
   - フィードバックの反映
   - リファクタリング
   - ドキュメントの更新
   - 変更履歴の記録

## 5. コードレビュー (review)
### 説明
生成されたコードをレビューし、品質評価と改善提案を行う

### 設定
```yaml
workflow:
  name: review
  description: 生成されたコードをレビューし、品質評価と改善提案を行う
  rules: 
    - .cursor/rules/project_rules.mdc
    - .cursor/rules/review.mdc
    - .cursor/rules/architecture.mdc
    - .cursor/rules/php.mdc
    - .cursor/rules/docker.mdc
  dependencies:
    - previous: lastResponse
  inputs:
    - name: reviewType
      type: select
      options: [コードレビュー, ペアプログラミング, 自己レビュー]
      description: レビュー方法を選択してください
    - name: currentVersion
      type: string
      description: package.jsonから取得した現在のバージョン
      default: ${package.json.version}
```

### 実行手順
1. コード品質評価
   - 静的解析
     - PHPStanによる型チェック
     - PHP_CodeSnifferによるコーディング規約チェック
     - 複雑度の測定
     - 重複コードの検出
   - テストカバレッジ
     - ユニットテストのカバレッジ
     - 統合テストのカバレッジ
     - E2Eテストのカバレッジ
   - パフォーマンス
     - クエリの最適化
     - メモリ使用量
     - レスポンスタイム

2. アーキテクチャ評価
   - 設計原則の遵守
     - SOLID原則
     - DRY原則
     - KISS原則
   - 依存関係
     - 循環依存の有無
     - 適切な抽象化
     - インターフェースの使用
   - 拡張性
     - 新機能追加の容易さ
     - 変更の影響範囲
     - モジュール性

3. セキュリティ評価
   - 脆弱性チェック
     - SQLインジェクション
     - XSS
     - CSRF
     - 認証・認可
   - データ保護
     - 機密情報の取り扱い
     - データの暗号化
     - アクセス制御
   - エラーハンドリング
     - 例外処理
     - ログ管理
     - エラーメッセージ

4. ドキュメント評価
   - コードコメント
     - PHPDocの記述
     - 複雑なロジックの説明
     - TODOコメント
   - APIドキュメント
     - エンドポイントの説明
     - リクエスト/レスポンス形式
     - エラーコード
   - 技術文書
     - アーキテクチャ図
     - シーケンス図
     - データベース設計書

5. 改善提案
   - 必須修正（MUST）
     - セキュリティ上の問題
     - 重大なバグ
     - パフォーマンスの問題
   - 推奨修正（SHOULD）
     - コードの可読性
     - 保守性の向上
     - テストの追加
   - 任意修正（MAY）
     - リファクタリング
     - ドキュメントの改善
     - 最適化

6. スコアリング
   - 評価項目
     - コード品質: 30点
     - アーキテクチャ: 25点
     - セキュリティ: 20点
     - ドキュメント: 15点
     - テスト: 10点
   - 評価基準
     - 90点以上: 優
     - 80点以上: 良
     - 70点以上: 可
     - 70点未満: 不可
   - 改善目標
     - 各項目の最低点設定
     - 優先度の高い項目の重点評価
     - 継続的な改善計画

## 6. 自動化設定 (automation)
### 説明
GitHub Actionsを使用した自動化プロセスの設定

### 設定
```yaml
workflow:
  name: automation
  description: GitHub Actionsを使用した自動化プロセスの設定
  rules: 
    - .cursor/rules/project_rules.mdc
  dependencies:
    - previous: lastResponse
```

### 実行手順
1. CI/CDパイプライン
   - 自動テスト実行
     - ユニットテスト
     - 統合テスト
     - E2Eテスト
   - 静的解析
     - PHPStan
     - PHP_CodeSniffer
     - セキュリティスキャン
   - ビルドとデプロイ
     - 環境別デプロイ設定
     - ロールバック手順
     - デプロイ承認フロー

2. パフォーマンスモニタリング
   - メトリクス収集
     - レスポンスタイム
     - メモリ使用量
     - CPU使用率
   - アラート設定
     - しきい値の定義
     - 通知チャンネル
     - エスカレーションルール
   - レポート生成
     - 日次レポート
     - 週次レポート
     - 月次レポート

3. エラー監視
   - エラートラッキング
     - エラーログの収集
     - エラー分類
     - 影響度評価
   - アラート設定
     - 重大度別通知
     - エスカレーションフロー
     - 対応時間目標
   - インシデント管理
     - インシデント登録
     - 原因分析
     - 再発防止策

## 7. エラー処理 (error-handling)
### 説明
エラー発生時の対応フローとロールバック手順

### 設定
```yaml
workflow:
  name: error-handling
  description: エラー発生時の対応フローとロールバック手順
  rules: 
    - .cursor/rules/project_rules.mdc
    - .cursor/rules/error-handling.mdc
  dependencies:
    - previous: lastResponse
```

### 実行手順
1. エラー検知
   - 監視項目
     - アプリケーションログ
     - システムログ
     - パフォーマンスメトリクス
   - アラート条件
     - エラー率
     - レスポンスタイム
     - リソース使用率
   - 通知方法
     - Slack通知
     - メール通知
     - 電話通知

2. 初期対応
   - 影響度評価
     - ユーザー影響
     - ビジネス影響
     - システム影響
   - 一時対応
     - サービス停止
     - 機能制限
     - 代替手段提供
   - エスカレーション
     - 担当者連絡
     - 管理者連絡
     - 経営層連絡

3. 原因分析
   - ログ分析
     - エラーログ
     - アクセスログ
     - システムログ
   - コードレビュー
     - 変更履歴
     - 関連コード
     - 依存関係
   - 環境確認
     - 設定値
     - リソース状態
     - ネットワーク状態

4. 復旧手順
   - ロールバック
     - コードロールバック
     - データベースロールバック
     - 設定ロールバック
   - 機能復旧
     - サービス再開
     - 機能確認
     - 動作確認
   - 影響確認
     - ユーザー確認
     - システム確認
     - ビジネス確認

5. 再発防止
   - 対策実施
     - コード修正
     - 設定変更
     - 監視強化
   - ドキュメント更新
     - 手順書更新
     - 設計書更新
     - 運用マニュアル更新
   - 教育・訓練
     - チーム研修
     - 手順確認
     - 訓練実施

# 注意事項
- 各ワークフローは順番に実行する必要があります
- 入力ファイルは適切な形式で準備してください
- ステップ番号は1から始まる連番で指定してください
- 各フェーズでの成果物は必ずバージョン管理してください
- 定期的な進捗報告とステータス更新を行ってください
- バージョン番号はセマンティックバージョニングに従って更新してください
- package.jsonのバージョン更新は、変更の影響度に応じて適切に行ってください
- クリーンアーキテクチャの原則に従って実装してください
- セキュリティ対策を常に意識してください
- パフォーマンス最適化を考慮してください
- データベースの変更は常に新しいマイグレーションファイルを作成して行ってください

# パフォーマンス目標値
## レスポンスタイム
- APIエンドポイント: 200ms以下
- ページロード: 2秒以下
- データベースクエリ: 100ms以下

## リソース使用率
- CPU使用率: 70%以下
- メモリ使用率: 80%以下
- ディスク使用率: 85%以下

## エラー率
- アプリケーションエラー: 0.1%以下
- システムエラー: 0.01%以下
- タイムアウト: 0.05%以下

# セキュリティ要件
## 認証・認可
- セッション管理
  - タイムアウト: 30分
  - 同時ログイン: 1デバイスのみ
  - セッション固定化対策: 実装必須

## データ保護
- 暗号化
  - 通信: TLS 1.3
  - 保存: AES-256
  - ハッシュ: bcrypt
- アクセス制御
  - 最小権限の原則
  - ロールベースアクセス制御
  - 監査ログの保存

## 脆弱性対策
- 定期的なスキャン
  - CI/CD: 自動スキャン
  - 四半期: 外部監査
  - 必要時: AeyeScan手動実施
    - 新機能リリース前
    - 重大なセキュリティアップデート後

# GitHub Actions設定
## CI/CDパイプライン
### 自動テスト
- ユニットテスト
  - PHPUnit
  - テストカバレッジ80%以上
  - 失敗時の通知設定
- 統合テスト
  - APIテスト
  - データベーステスト
  - 外部サービス連携テスト
- E2Eテスト
  - mablテストの必要性の判断

### 静的解析
- セキュリティスキャン
  - OWASP ZAP
  - 依存関係チェック
  - 脆弱性検出時の通知

### デプロイメント
- 環境別設定
  - 開発環境
  - ステージング環境
  - 本番環境
- ロールバック手順
  - 自動ロールバック
  - 手動ロールバック
  - データベースロールバック
- デプロイ承認
  - レビュー承認
  - テスト承認
  - セキュリティ承認

## モニタリング
### パフォーマンス
- メトリクス収集
  - Grafana
  - Google Cloud Monitoring
- アラート設定
  - しきい値
  - 通知チャンネル
  - エスカレーション

### エラー監視
- エラートラッキング
  - エラー分類
  - 影響度評価
- アラート設定
  - 重大度別
  - 通知方法